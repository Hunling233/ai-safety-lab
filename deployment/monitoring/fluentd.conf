# AI Safety Lab - 日志配置
# Fluentd日志收集和转发配置

# 输入源配置
<source>
  @type tail
  @id ai_safety_backend_logs
  path /app/logs/aisafety.log
  pos_file /var/log/fluentd/aisafety.log.pos
  tag aisafety.backend
  format json
  time_key time
  time_format %Y-%m-%d %H:%M:%S
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id kubernetes_container_logs
  path /var/log/containers/ai-safety*.log
  pos_file /var/log/fluentd/containers.log.pos
  tag kubernetes.*
  format json
  time_key time
  keep_time_key true
  read_from_head true
</source>

# 过滤和解析
<filter aisafety.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment "production"
    application "ai-safety-lab"
    namespace "unicc-aisafety"
  </record>
</filter>

<filter kubernetes.**>
  @type kubernetes_metadata
  @id kubernetes_metadata_filter
  kubernetes_url "#{ENV['FLUENT_FILTER_KUBERNETES_URL'] || 'https://' + ENV.fetch('KUBERNETES_SERVICE_HOST') + ':' + ENV.fetch('KUBERNETES_SERVICE_PORT') + '/api'}"
  verify_ssl "#{ENV['KUBERNETES_VERIFY_SSL'] || true}"
  ca_file "#{ENV['KUBERNETES_CA_FILE']}"
  skip_labels false
  skip_container_metadata false
  skip_master_url false
  skip_namespace_metadata false
</filter>

# 错误日志特殊处理
<filter aisafety.**>
  @type grep
  <regexp>
    key level
    pattern ^(ERROR|CRITICAL|FATAL)$
  </regexp>
  @id error_logs_filter
  add_tag_prefix error
</filter>

# 安全事件日志
<filter aisafety.**>
  @type grep
  <regexp>
    key message
    pattern (authentication|authorization|security|unauthorized|forbidden)
  </regexp>
  @id security_logs_filter
  add_tag_prefix security
</filter>

# 性能指标日志
<filter aisafety.**>
  @type grep
  <regexp>
    key message
    pattern (response_time|cpu_usage|memory_usage|test_duration)
  </regexp>
  @id performance_logs_filter
  add_tag_prefix performance
</filter>

# 输出配置
# 发送到UNICC日志聚合系统
<match aisafety.**>
  @type forward
  @id unicc_log_aggregator
  <server>
    name unicc-logaggregator
    host unicc-logs.local
    port 24224
    weight 60
  </server>
  <server>
    name unicc-logaggregator-backup
    host unicc-logs-backup.local
    port 24224
    weight 40
    standby
  </server>
  
  <security>
    self_hostname "#{Socket.gethostname}"
    shared_key "unicc-shared-key"
  </security>
  
  <buffer>
    @type file
    path /var/log/fluentd/unicc_buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

# 错误日志特殊处理 - 立即发送到告警系统
<match error.aisafety.**>
  @type http
  @id error_alerts
  endpoint http://alertmanager:9093/api/v1/alerts
  headers {"Content-Type":"application/json"}
  format json
  json_array true
  
  <buffer>
    @type memory
    flush_mode immediate
    retry_type exponential_backoff
    retry_forever false
    retry_max_times 3
  </buffer>
</match>

# 安全事件 - 发送到安全运营中心
<match security.aisafety.**>
  @type forward
  @id security_soc
  <server>
    name unicc-soc
    host security.unicc.local
    port 24224
  </server>
  
  <security>
    self_hostname "#{Socket.gethostname}"
    shared_key "security-shared-key"
  </security>
  
  <buffer>
    @type file
    path /var/log/fluentd/security_buffer
    flush_mode immediate
    retry_type exponential_backoff
    flush_thread_count 1
    retry_forever true
    retry_max_interval 10
  </buffer>
</match>

# 性能指标 - 发送到监控系统
<match performance.aisafety.**>
  @type prometheus
  @id performance_metrics
  <metric>
    name aisafety_response_time_seconds
    type gauge
    desc AI Safety response time in seconds
    key response_time
    <labels>
      service ${service}
      endpoint ${endpoint}
    </labels>
  </metric>
  
  <metric>
    name aisafety_test_duration_seconds
    type histogram
    desc AI Safety test duration in seconds
    key test_duration
    buckets 0.1,0.5,1,2,5,10,30,60
    <labels>
      test_suite ${test_suite}
      agent_type ${agent_type}
    </labels>
  </metric>
</match>

# Kubernetes日志路由
<match kubernetes.**>
  @type rewrite_tag_filter
  <rule>
    key $.kubernetes.container_name
    pattern ^ai-safety-.*
    tag aisafety.k8s.${tag}
  </rule>
  <rule>
    key $.kubernetes.container_name
    pattern .*
    tag k8s.${tag}
  </rule>
</match>

# 本地备份存储
<match **>
  @type copy
  
  <store>
    @type file
    @id local_backup
    path /var/log/aisafety/backup
    append true
    time_slice_format %Y%m%d%H
    time_slice_wait 10m
    time_format %Y%m%dT%H%M%S%z
    compress gzip
  </store>
</match>